<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ï¢ÖÏ∞¨ Ï∫òÎ¶∞Îçî ÏùºÏ†ïÌëú</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Malgun Gothic, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 24px;
    }
    #calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding: 12px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    #calendar-header button {
      padding: 10px 18px;
      font-size: 1rem;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #calendar-header button:hover {
      background: #f0f0f0;
    }
    #current-month {
      font-size: 1.25rem;
      color: #333;
    }
    #calendar {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
  /* Ensure all weekday headers (including ÌÜ†) are visible on narrow screens by allowing horizontal scroll */
  .table-container { overflow-x: auto; }
  #calendar { min-width: 700px; }
    #calendar th {
      padding: 12px 8px;
      background: #4a90d9;
      color: #fff;
      font-weight: 600;
      text-align: center;
    }
    #calendar th:last-child { color: #3498db; }
    #calendar td {
      padding: 0;
      border: 1px solid #eee;
      vertical-align: top;
      height: 100px;
      max-height: 100px;
    }
    #calendar .day-cell-inner {
      height: 100%;
      min-height: 100px;
      max-height: 100px;
      overflow: hidden;
      padding: 4px 6px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      position: relative;
    }
    #calendar .day-cell-inner .day-num { flex-shrink: 0; }
    #calendar .day-cell-inner .events-list { flex-shrink: 1; min-height: 0; overflow: hidden; }
    #calendar .day-cell-inner .day-work-label,
    #calendar .day-cell-inner .day-location { flex-shrink: 0; min-height: 0; overflow: hidden; text-overflow: ellipsis; }
    #calendar td.other-month .day-num { color: #bbb; }
    #calendar td.today .day-num {
      background: #4a90d9;
      color: #fff;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      line-height: 28px;
      text-align: center;
      margin: 4px;
      padding: 0;
    }
    #calendar .day-cell {
      cursor: pointer;
      transition: background 0.15s;
    }
    #calendar .day-cell:hover { background: #f8f9fa; }
    #calendar .events-list {
      list-style: none;
      margin: 0;
      padding: 4px 6px;
      font-size: 0.75rem;
    }
    #calendar .events-list li {
      padding: 2px 6px;
      margin-bottom: 2px;
      background: #e8f4fc;
      border-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  /* Holiday (ÏÑ§ÎÇ† Îì±) styling */
  #calendar td.holiday .day-num { color: #e74c3c; font-weight: 700; }
  #calendar .events-list li.holiday { background: #fdecea; color: #c0392b; }
  /* weekday label inside day cells (small) - removed span insertion in JS; kept style in case needed */
    /* weekend coloring for date numbers */
    #calendar td.sunday .day-num { color: #e74c3c; font-weight: 700; }
    #calendar td.saturday .day-num { color: #3498db; font-weight: 700; }
    #modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #modal-overlay.show { display: flex; }
    #modal {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 360px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    #modal h3 { margin-top: 0; color: #333; }
    #modal label { display: block; margin-bottom: 4px; font-weight: 500; color: #555; }
    #modal input[type="date"],
    #modal input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    #modal-close, #save-event {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    #modal-close {
      background: #eee;
      color: #333;
      margin-right: 8px;
    }
    #save-event {
      background: #4a90d9;
      color: #fff;
    }
    #save-event:hover { background: #3a7bc8; }
    .salary-panel {
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .salary-panel h2 { margin: 0 0 12px 0; font-size: 1rem; color: #555; }
    .wage-options { display: flex; gap: 20px; align-items: center; margin-bottom: 12px; }
    .wage-options label { display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0; font-weight: normal; }
    .wage-options input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .salary-summary {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      padding: 12px 0;
      border-top: 1px solid #eee;
    }
    .salary-summary .amount { color: #27ae60; font-size: 1.35rem; }
    #calendar .day-cell.worked .day-num { background: #27ae60 !important; color: #fff; border-radius: 50%; width: 28px; height: 28px; line-height: 28px; text-align: center; margin: 4px; padding: 0; }
    #calendar .day-cell.worked .day-work-label { display: block; font-size: 0.65rem; color: #27ae60; padding: 0 6px 4px; font-weight: 600; }
    #calendar .day-cell.worked .day-location { display: block; font-size: 0.7rem; color: #555; padding: 0 6px 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #calendar td.today.worked .day-num { background: #1e8449 !important; }
    .location-panel { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
    .location-panel label { margin: 0; font-weight: 500; color: #555; }
    #work-location-input { flex: 1; min-width: 160px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    .modal-row { margin-bottom: 16px; }
    .modal-row label { margin-bottom: 4px; }
    #worked-checkbox { width: 18px; height: 18px; margin-right: 8px; vertical-align: middle; cursor: pointer; }
    .auth-panel {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .auth-panel h2 { margin: 0 0 12px 0; font-size: 1rem; color: #555; }
    .auth-form { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px; }
    .auth-form input { padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    .auth-form input[type="email"], .auth-form input[type="password"] { width: 180px; }
    .auth-form button { padding: 10px 16px; border-radius: 8px; font-size: 0.95rem; cursor: pointer; border: none; }
    .btn-login { background: #4a90d9; color: #fff; }
    .btn-signup { background: #eee; color: #333; }
    .btn-logout { background: #e74c3c; color: #fff; }
    .auth-status { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
    .auth-status span { color: #555; font-size: 0.95rem; }
    .auth-msg { font-size: 0.9rem; margin-top: 8px; min-height: 1.2em; }
    .auth-msg.error { color: #c0392b; }
    .auth-msg.success { color: #27ae60; }
    #main-content.hidden { display: none; }
  </style>
</head>
<body>
  <h1>üìÖ Ï¢ÖÏ∞¨ Í∑ºÎ¨¥ ÏùºÏ†ïÌëú</h1>

  <div class="auth-panel" id="auth-panel">
    <div id="auth-login-form">
      <h2>üîê Î°úÍ∑∏Ïù∏</h2>
      <div class="auth-form">
        <input type="email" id="auth-email" placeholder="Ïù¥Î©îÏùº" autocomplete="email" />
        <input type="password" id="auth-password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="current-password" />
        <button type="button" class="btn-login" id="btn-login">Î°úÍ∑∏Ïù∏</button>
        <button type="button" class="btn-signup" id="btn-signup">ÌöåÏõêÍ∞ÄÏûÖ</button>
      </div>
      <div class="auth-msg" id="auth-msg"></div>
    </div>
    <div id="auth-logged-in" style="display:none;">
      <div class="auth-status">
        <span id="auth-user-email"></span>
        <button type="button" class="btn-logout" id="btn-logout">Î°úÍ∑∏ÏïÑÏõÉ</button>
      </div>
      <div class="auth-msg" id="auth-msg-logged"></div>
    </div>
  </div>

  <div id="main-content">
  <div class="salary-panel">
    <h2>üí∞ ÏùºÎãπ ÏÑ†ÌÉù</h2>
    <div class="wage-options">
      <label><input type="radio" name="wage" id="wage-15" /> 15ÎßåÏõê</label>
      <label><input type="radio" name="wage" id="wage-16" /> 16ÎßåÏõê</label>
      <label><input type="radio" name="wage" id="wage-17" /> 17ÎßåÏõê</label>
      <label><input type="radio" name="wage" id="wage-18" /> 18ÎßåÏõê</label>
      <label><input type="radio" name="wage" id="wage-19" /> 19ÎßåÏõê</label>
      <label><input type="radio" name="wage" id="wage-20" /> 20ÎßåÏõê</label>
    </div>
    <div class="salary-summary" id="salary-summary">
      Ïù¥Î≤à Îã¨ Ï∂úÍ∑º <strong id="worked-days-count">0</strong>Ïùº ¬∑ ÏòàÏÉÅ ÏõîÍ∏â <span class="amount" id="salary-amount">0Ïõê</span>
    </div>
  </div>

  <div id="calendar-header">
    <button id="prev-month" type="button">‚óÄ Ïù¥Ï†Ñ</button>
    <span id="current-month"></span>
    <button id="next-month" type="button">Îã§Ïùå ‚ñ∂</button>
  </div>

  <div class="table-container">
    <table id="calendar">
      <thead>
        <tr>
          <th>Ïùº</th><th>Ïõî</th><th>Ìôî</th><th>Ïàò</th><th>Î™©</th><th>Í∏à</th><th>ÌÜ†</th>
        </tr>
      </thead>
      <tbody id="calendar-body"></tbody>
    </table>
  </div>

  <div class="salary-panel location-panel" id="location-panel">
    <span id="location-date-label">ÎÇ†ÏßúÎ•º ÌÅ¥Î¶≠Ìïú Îí§ Ï∂úÍ∑º Ïû•ÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</span>
    <input type="text" id="work-location-input" placeholder="Ïòà: Í∞ïÎÇ®Ï†ê, Î≥∏ÏÇ¨" maxlength="30" />
  </div>
  </div>

  <div id="modal-overlay">
    <div id="modal">
      <h3 id="modal-title">ÏùºÏ†ï Ï∂îÍ∞Ä</h3>
      <label for="event-date">ÎÇ†Ïßú</label>
      <input type="date" id="event-date" />
      <div class="modal-row">
        <label><input type="checkbox" id="worked-checkbox" /> Ïù¥ ÎÇ† Ï∂úÍ∑ºÌñàÏñ¥Ïöî</label>
      </div>
      <label for="event-title">ÏùºÏ†ï ÎÇ¥Ïö©</label>
      <input type="text" id="event-title" placeholder="ÏùºÏ†ïÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉù)" maxlength="50" />
      <div style="margin-top:16px;">
        <button type="button" id="modal-close">Ï∑®ÏÜå</button>
        <button type="button" id="save-event">Ï†ÄÏû•</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    (function () {
      // Firebase ÏÑ§Ï†ï: Í≥ÑÏ†ï Î°úÍ∑∏Ïù∏ + Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ ÏÇ¨Ïö© Ïãú
      // 1. https://console.firebase.google.com ‚Üí ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä ‚Üí Ïï±(Ïõπ) Ï∂îÍ∞Ä ‚Üí config Î≥µÏÇ¨ ÌõÑ ÏïÑÎûòÏóê Î∂ôÏó¨ÎÑ£Í∏∞
      // 2. Authentication ‚Üí Î°úÍ∑∏Ïù∏ Î∞©Î≤ï ‚Üí Ïù¥Î©îÏùº/ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÇ¨Ïö© ÏÑ§Ï†ï
      // 3. Firestore Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÎßåÎì§Í∏∞ ‚Üí Í∑úÏπô: users/{userId} Î≥∏Ïù∏Îßå ÏùΩÍ∏∞/Ïì∞Í∏∞ ÌóàÏö© (Ïòà: allow read, write: if request.auth.uid == userId;)
      var FIREBASE_CONFIG = null;
      // Ïòà: FIREBASE_CONFIG = { apiKey: "AIza...", authDomain: "myproject.firebaseapp.com", projectId: "myproject", storageBucket: "myproject.appspot.com", messagingSenderId: "123", appId: "1:123:web:abc" };

      const STORAGE_KEY = 'calendar_events';
      const WORKED_KEY = 'calendar_worked_days';
      const WAGE_KEY = 'calendar_daily_wage';
      const LOCATIONS_KEY = 'calendar_work_locations';
      let currentDate = new Date();
      let selectedDate = null;
      var firebaseApp = null;
      var firebaseAuth = null;
      var firebaseDb = null;

      function initFirebase() {
        if (!FIREBASE_CONFIG || typeof firebase === 'undefined') return false;
        try {
          firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
          firebaseAuth = firebase.auth();
          firebaseDb = firebase.firestore();
          return true;
        } catch (e) {
          console.warn('Firebase init failed', e);
          return false;
        }
      }

      function showAuthMsg(elId, text, isError) {
        var el = document.getElementById(elId);
        if (!el) return;
        el.textContent = text || '';
        el.className = 'auth-msg' + (isError ? ' error' : text ? ' success' : '');
      }

      function setAuthUI(loggedIn, email) {
        var hasFirebase = !!(firebaseApp && firebaseAuth);
        var loginForm = document.getElementById('auth-login-form');
        var loggedInDiv = document.getElementById('auth-logged-in');
        var mainContent = document.getElementById('main-content');
        var authPanelEl = document.getElementById('auth-panel');
        if (!hasFirebase) {
          if (authPanelEl) authPanelEl.style.display = 'none';
          if (mainContent) mainContent.classList.remove('hidden');
          return;
        }
        if (authPanelEl) authPanelEl.style.display = 'block';
        if (loginForm) loginForm.style.display = loggedIn ? 'none' : 'block';
        if (loggedInDiv) {
          loggedInDiv.style.display = loggedIn ? 'block' : 'none';
          var emailEl = document.getElementById('auth-user-email');
          if (emailEl) emailEl.textContent = (email || '') + ' Î°úÍ∑∏Ïù∏ Ï§ë';
        }
        if (mainContent) mainContent.classList.toggle('hidden', !loggedIn);
        showAuthMsg('auth-msg', '');
        showAuthMsg('auth-msg-logged', '');
      }

      function userDataRef() {
        if (!firebaseAuth || !firebaseDb) return null;
        var user = firebaseAuth.currentUser;
        if (!user) return null;
        return firebaseDb.collection('users').doc(user.uid);
      }

      function saveToFirestore() {
        var ref = userDataRef();
        if (!ref) return Promise.resolve();
        var data = {
          events: getEvents(),
          workedDays: getWorkedDays(),
          dailyWage: getDailyWage(),
          workLocations: getWorkLocations(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        return ref.set(data, { merge: true }).catch(function (err) {
          console.warn('Firestore save failed', err);
          showAuthMsg('auth-msg-logged', 'Ï†ÄÏû• Ïã§Ìå®: ' + (err.message || 'ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏'), true);
        });
      }

      function loadFromFirestore() {
        var ref = userDataRef();
        if (!ref) return Promise.resolve();
        return ref.get().then(function (snap) {
          if (!snap.exists) return;
          var d = snap.data();
          if (d.events) localStorage.setItem(STORAGE_KEY, JSON.stringify(d.events));
          if (d.workedDays) localStorage.setItem(WORKED_KEY, JSON.stringify(d.workedDays));
          if (d.dailyWage != null) localStorage.setItem(WAGE_KEY, String(d.dailyWage));
          if (d.workLocations) localStorage.setItem(LOCATIONS_KEY, JSON.stringify(d.workLocations));
          renderHeader();
          renderCalendar();
          updateSalarySummary();
          if (selectedDate) updateLocationPanel(selectedDate);
        }).catch(function (err) {
          console.warn('Firestore load failed', err);
          showAuthMsg('auth-msg-logged', 'Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + (err.message || 'ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏'), true);
        });
      }

      var authPanel = document.getElementById('auth-panel');
      if (initFirebase()) {
        firebaseAuth.onAuthStateChanged(function (user) {
          setAuthUI(!!user, user ? user.email : '');
          if (user) {
            loadFromFirestore();
          }
        });
      } else {
        setAuthUI(false);
      }

      function getEvents() {
        try {
          const data = localStorage.getItem(STORAGE_KEY);
          return data ? JSON.parse(data) : {};
        } catch (e) {
          return {};
        }
      }

      function saveEvents(events) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
        syncToFirestore();
      }

      function getWorkedDays() {
        try {
          const data = localStorage.getItem(WORKED_KEY);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          return [];
        }
      }

      function saveWorkedDays(days) {
        localStorage.setItem(WORKED_KEY, JSON.stringify(days));
        syncToFirestore();
      }

      function getWorkLocations() {
        try {
          const data = localStorage.getItem(LOCATIONS_KEY);
          return data ? JSON.parse(data) : {};
        } catch (e) {
          return {};
        }
      }

      function saveWorkLocations(locations) {
        localStorage.setItem(LOCATIONS_KEY, JSON.stringify(locations));
        syncToFirestore();
      }

      function syncToFirestore() {
        if (!userDataRef()) return;
        saveToFirestore().then(function () {
          showAuthMsg('auth-msg-logged', 'Ï†ÄÏû•Îê®', false);
          setTimeout(function () { showAuthMsg('auth-msg-logged', ''); }, 2000);
        });
      }

      function getDailyWage() {
        const w = localStorage.getItem(WAGE_KEY);
        // default to 150000 if not set
        const num = w ? Number(w) : 150000;
        // allow only 150000-200000 by 10000 steps
        var allowed = [150000,160000,170000,180000,190000,200000];
        if (allowed.indexOf(num) >= 0) return num;
        return 150000;
      }

      function setDailyWage(value) {
        const v = Number(value) || 150000;
        localStorage.setItem(WAGE_KEY, String(v));
        updateSalarySummary();
        syncToFirestore();
      }

      function formatMoney(n) {
        return n.toLocaleString('ko-KR') + 'Ïõê';
      }

      function updateSalarySummary() {
        const wage = getDailyWage();
        const worked = getWorkedDays();
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth();
        const inMonth = worked.filter(function (dateStr) {
          const [dy, dm] = dateStr.split('-').map(Number);
          return dy === y && dm === m + 1;
        });
        const count = inMonth.length;
        const total = count * wage;
        const countEl = document.getElementById('worked-days-count');
        const amountEl = document.getElementById('salary-amount');
        if (countEl) countEl.textContent = count;
        if (amountEl) amountEl.textContent = formatMoney(total);
      }

      function dateKey(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return y + '-' + m + '-' + d;
      }

      // Precomputed main lunar holiday dates (Seollal and Chuseok) by year.
      // We'll expand each main date into a 3-day range (day-1, day, day+1) when building the holiday map.
      var PRECOMPUTED_LUNAR = {
        '2023': { seollal: '2023-01-22', chuseok: '2023-09-29' },
        '2024': { seollal: '2024-02-10', chuseok: '2024-09-17' },
        '2025': { seollal: '2025-01-29', chuseok: '2025-10-06' },
        '2026': { seollal: '2026-02-17', chuseok: '2026-09-25' },
        '2027': { seollal: '2027-02-07', chuseok: '2027-09-15' },
        '2028': { seollal: '2028-01-27', chuseok: '2028-10-03' },
        '2029': { seollal: '2029-02-13', chuseok: '2029-09-22' },
        '2030': { seollal: '2030-02-03', chuseok: '2030-09-12' },
        '2031': { seollal: '2031-01-23', chuseok: '2031-10-01' },
        '2032': { seollal: '2032-02-11', chuseok: '2032-09-19' }
      };

      // helper: add day offsets (-1,0,+1) for a base date into map
      function addThreeDayRange(map, baseDateStr, mainLabel, adjLabel) {
        var base = new Date(baseDateStr + 'T00:00:00');
        for (var offset = -1; offset <= 1; offset++) {
          var d = new Date(base);
          d.setDate(base.getDate() + offset);
          var k = dateKey(d);
          map[k] = (offset === 0) ? mainLabel : adjLabel;
        }
      }

      // Return map of dateKey -> holidayName for common Korean public holidays for the given year.
      // This merges fixed-date holidays plus expanded lunar holidays from PRECOMPUTED_LUNAR.
      function getNationalHolidays(year) {
        var map = {};
        // Fixed-date holidays (apply every year)
        map[year + '-01-01'] = 'Ïã†Ï†ï'; // New Year's Day
        map[year + '-03-01'] = 'ÏÇºÏùºÏ†à';
        map[year + '-05-05'] = 'Ïñ¥Î¶∞Ïù¥ÎÇ†';
        map[year + '-06-06'] = 'ÌòÑÏ∂©Ïùº';
        map[year + '-08-15'] = 'Í¥ëÎ≥µÏ†à';
        map[year + '-10-03'] = 'Í∞úÏ≤úÏ†à';
        map[year + '-10-09'] = 'ÌïúÍ∏ÄÎÇ†';
        map[year + '-12-25'] = 'ÏÑ±ÌÉÑÏ†à';

        var py = String(year);
        if (PRECOMPUTED_LUNAR[py]) {
          var p = PRECOMPUTED_LUNAR[py];
          if (p.seollal) addThreeDayRange(map, p.seollal, 'ÏÑ§ÎÇ†', 'ÏÑ§ÎÇ† Ïó∞Ìú¥');
          if (p.chuseok) addThreeDayRange(map, p.chuseok, 'Ï∂îÏÑù', 'Ï∂îÏÑù Ïó∞Ìú¥');
        }

        return map;
      }

      function renderHeader() {
        const el = document.getElementById('current-month');
        if (!el) return;
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth() + 1;
        el.textContent = y + 'ÎÖÑ ' + m + 'Ïõî';
      }

      function renderCalendar() {
        const tbody = document.getElementById('calendar-body');
        if (!tbody) return;

        const y = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const first = new Date(y, month, 1);
        const last = new Date(y, month + 1, 0);
        const startDay = first.getDay();
        const daysInMonth = last.getDate();

        const todayKey = dateKey(new Date());
  const events = getEvents();
        const locations = getWorkLocations();
  const holidays = getNationalHolidays(y || currentDate.getFullYear());
        const workedSet = {};
        getWorkedDays().forEach(function (d) { workedSet[d] = true; });

        let html = '';
        let dayCount = 1;
        const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;

        for (let i = 0; i < totalCells; i++) {
          if (i % 7 === 0) html += '<tr>';

          if (i < startDay || dayCount > daysInMonth) {
            const prevMonth = new Date(y, month, 1 - (startDay - i));
            const otherDate = i < startDay
              ? new Date(y, month, 1 - (startDay - i))
              : new Date(y, month + 1, dayCount - daysInMonth);
            const key = dateKey(otherDate);
            var dayEvents = (events[key] || []).slice();
            // include holiday name for display (non-persistent)
            if (holidays[key] && dayEvents.indexOf(holidays[key]) < 0) dayEvents.unshift(holidays[key]);
            const isToday = key === todayKey;
            const isWorked = workedSet[key];
            // detect holiday by holiday map or event text
            const hasHolidayEvent = !!holidays[key] || dayEvents.some(function(ev){ return /ÏÑ§ÎÇ†|Ï∂îÏÑù|Ïó∞Ìú¥|Ïã†Ï†ï|Í¥ëÎ≥µ|ÌïúÍ∏Ä|ÏÑ±ÌÉÑ/i.test(ev); });
            // weekday index for this cell (0=Sun ... 6=Sat)
            var weekdayIdx = i % 7;
            var extraClass = '';
            if (weekdayIdx === 0) extraClass = ' sunday';
            if (weekdayIdx === 6) extraClass = ' saturday';
            html += '<td class="day-cell other-month' + (isToday ? ' today' : '') + (isWorked ? ' worked' : '') + (hasHolidayEvent ? ' holiday' : '') + extraClass + '" data-date="' + key + '"><div class="day-cell-inner">';
            // weekday label spans removed per user request
            html += '<span class="day-num">' + (i < startDay ? prevMonth.getDate() : (dayCount - daysInMonth)) + '</span>';
            if (dayEvents.length) {
              html += '<ul class="events-list">';
              dayEvents.slice(0, 3).forEach(function (ev) {
                var liClass = /ÏÑ§ÎÇ†/i.test(ev) ? ' class="holiday"' : '';
                html += '<li' + liClass + '>' + escapeHtml(ev) + '</li>';
              });
              if (dayEvents.length > 3) html += '<li>+' + (dayEvents.length - 3) + '</li>';
              html += '</ul>';
            }
            if (isWorked) {
              html += '<span class="day-work-label">Ï∂úÍ∑º</span>';
              if (locations[key]) html += '<span class="day-location">' + escapeHtml(locations[key]) + '</span>';
            }
            html += '</div></td>';
            if (i >= startDay && dayCount > daysInMonth) dayCount++;
          } else {
            const key = dateKey(new Date(y, month, dayCount));
            var dayEvents = (events[key] || []).slice();
            if (holidays[key] && dayEvents.indexOf(holidays[key]) < 0) dayEvents.unshift(holidays[key]);
            const isToday = key === todayKey;
            const isWorked = workedSet[key];
            const hasHolidayEvent = !!holidays[key] || dayEvents.some(function(ev){ return /ÏÑ§ÎÇ†|Ï∂îÏÑù|Ïó∞Ìú¥|Ïã†Ï†ï|Í¥ëÎ≥µ|ÌïúÍ∏Ä|ÏÑ±ÌÉÑ/i.test(ev); });
            var weekdayIdx2 = i % 7;
            var extraClass2 = '';
            if (weekdayIdx2 === 0) extraClass2 = ' sunday';
            if (weekdayIdx2 === 6) extraClass2 = ' saturday';
            html += '<td class="day-cell' + (isToday ? ' today' : '') + (isWorked ? ' worked' : '') + (hasHolidayEvent ? ' holiday' : '') + extraClass2 + '" data-date="' + key + '"><div class="day-cell-inner">';
            // weekday label spans removed per user request
            html += '<span class="day-num">' + dayCount + '</span>';
            if (dayEvents.length) {
              html += '<ul class="events-list">';
              dayEvents.slice(0, 3).forEach(function (ev) {
                var liClass = /ÏÑ§ÎÇ†/i.test(ev) ? ' class="holiday"' : '';
                html += '<li' + liClass + '>' + escapeHtml(ev) + '</li>';
              });
              if (dayEvents.length > 3) html += '<li>+' + (dayEvents.length - 3) + '</li>';
              html += '</ul>';
            }
            if (isWorked) {
              html += '<span class="day-work-label">Ï∂úÍ∑º</span>';
              if (locations[key]) html += '<span class="day-location">' + escapeHtml(locations[key]) + '</span>';
            }
            html += '</div></td>';
            dayCount++;
          }

          if (i % 7 === 6) html += '</tr>';
        }

        tbody.innerHTML = html;

        tbody.querySelectorAll('.day-cell').forEach(function (cell) {
          cell.addEventListener('click', function () {
            toggleWorked(this.getAttribute('data-date'));
          });
        });
        updateSalarySummary();
      }

      function updateLocationPanel(dateStr) {
        selectedDate = dateStr;
        var label = document.getElementById('location-date-label');
        var input = document.getElementById('work-location-input');
        if (label) label.textContent = dateStr + ' Ï∂úÍ∑º Ïû•ÏÜå';
        if (input) {
          input.value = (getWorkLocations()[dateStr] || '');
          input.placeholder = 'Ïòà: Í∞ïÎÇ®Ï†ê, Î≥∏ÏÇ¨';
          input.focus();
        }
      }

      function saveLocationInput() {
        if (!selectedDate) return;
        var input = document.getElementById('work-location-input');
        if (!input) return;
        var loc = input.value.trim();
        var locs = getWorkLocations();
        if (loc) locs[selectedDate] = loc;
        else delete locs[selectedDate];
        saveWorkLocations(locs);
        renderCalendar();
      }

      function toggleWorked(dateStr) {
        if (!dateStr) return;
        var worked = getWorkedDays();
        var idx = worked.indexOf(dateStr);
        if (idx >= 0) worked.splice(idx, 1);
        else worked.push(dateStr);
        saveWorkedDays(worked);
        selectedDate = dateStr;
        updateLocationPanel(dateStr);
        renderCalendar();
        updateSalarySummary();
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function openModal(dateStr) {
        document.getElementById('event-date').value = dateStr;
        document.getElementById('event-title').value = '';
        var worked = getWorkedDays().indexOf(dateStr) >= 0;
        document.getElementById('worked-checkbox').checked = worked;
        document.getElementById('modal-overlay').classList.add('show');
        document.getElementById('event-title').focus();
      }

      function closeModal() {
        document.getElementById('modal-overlay').classList.remove('show');
      }

      function onSaveEvent() {
        const dateStr = document.getElementById('event-date').value;
        const title = document.getElementById('event-title').value.trim();
        const workedChecked = document.getElementById('worked-checkbox').checked;
        if (!dateStr) return;

        var worked = getWorkedDays();
        var idx = worked.indexOf(dateStr);
        if (workedChecked && idx < 0) worked.push(dateStr);
        if (!workedChecked && idx >= 0) worked.splice(idx, 1);
        saveWorkedDays(worked);

        if (title) {
          const events = getEvents();
          if (!events[dateStr]) events[dateStr] = [];
          events[dateStr].push(title);
          saveEvents(events);
        }

        closeModal();
        renderCalendar();
        updateSalarySummary();
      }

      function prevMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderHeader();
        renderCalendar();
      }

      function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderHeader();
        renderCalendar();
      }

      document.getElementById('prev-month').addEventListener('click', prevMonth);
      document.getElementById('next-month').addEventListener('click', nextMonth);

      var btnLogin = document.getElementById('btn-login');
      var btnSignup = document.getElementById('btn-signup');
      var btnLogout = document.getElementById('btn-logout');
      if (btnLogin && firebaseAuth && firebaseApp) {
        btnLogin.addEventListener('click', function () {
          var email = document.getElementById('auth-email').value.trim();
          var password = document.getElementById('auth-password').value;
          showAuthMsg('auth-msg', '');
          if (!email || !password) { showAuthMsg('auth-msg', 'Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', true); return; }
          firebaseAuth.signInWithEmailAndPassword(email, password).then(function () {
            showAuthMsg('auth-msg', 'Î°úÍ∑∏Ïù∏ÎêòÏóàÏäµÎãàÎã§', false);
          }).catch(function (err) {
            showAuthMsg('auth-msg', err.message || 'Î°úÍ∑∏Ïù∏ Ïã§Ìå®', true);
          });
        });
      }
      if (btnSignup && firebaseAuth && firebaseApp) {
        btnSignup.addEventListener('click', function () {
          var email = document.getElementById('auth-email').value.trim();
          var password = document.getElementById('auth-password').value;
          showAuthMsg('auth-msg', '');
          if (!email || !password) { showAuthMsg('auth-msg', 'Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', true); return; }
          if (password.length < 6) { showAuthMsg('auth-msg', 'ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 6Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§', true); return; }
          firebaseAuth.createUserWithEmailAndPassword(email, password).then(function () {
            showAuthMsg('auth-msg', 'ÌöåÏõêÍ∞ÄÏûÖÎêòÏóàÏäµÎãàÎã§. Î°úÍ∑∏Ïù∏ Ï§ë...', false);
          }).catch(function (err) {
            showAuthMsg('auth-msg', err.message || 'ÌöåÏõêÍ∞ÄÏûÖ Ïã§Ìå®', true);
          });
        });
      }
      if (btnLogout && firebaseAuth && firebaseApp) {
        btnLogout.addEventListener('click', function () {
          firebaseAuth.signOut();
        });
      }

      document.getElementById('modal-close').addEventListener('click', closeModal);
      document.getElementById('save-event').addEventListener('click', onSaveEvent);
      document.getElementById('modal-overlay').addEventListener('click', function (e) {
        if (e.target === this) closeModal();
      });
      document.getElementById('event-title').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') onSaveEvent();
      });
      document.getElementById('work-location-input').addEventListener('blur', saveLocationInput);
      document.getElementById('work-location-input').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') { saveLocationInput(); e.preventDefault(); }
      });

      var wage15 = document.getElementById('wage-15');
      var wage16 = document.getElementById('wage-16');
      var wage17 = document.getElementById('wage-17');
      var wage18 = document.getElementById('wage-18');
      var wage19 = document.getElementById('wage-19');
      var wage20 = document.getElementById('wage-20');
      var w = getDailyWage();
      wage15.checked = (w === 150000);
      wage16.checked = (w === 160000);
      wage17.checked = (w === 170000);
      wage18.checked = (w === 180000);
      wage19.checked = (w === 190000);
      wage20.checked = (w === 200000);
      [wage15, wage16, wage17, wage18, wage19, wage20].forEach(function (el) {
        el.addEventListener('change', function () {
          if (el.checked) {
            var val = 150000;
            if (el.id === 'wage-16') val = 160000;
            else if (el.id === 'wage-17') val = 170000;
            else if (el.id === 'wage-18') val = 180000;
            else if (el.id === 'wage-19') val = 190000;
            else if (el.id === 'wage-20') val = 200000;
            setDailyWage(val);
          }
        });
      });

      renderHeader();
      renderCalendar();
      updateSalarySummary();
    })();
  </script>
</body>
</html>
